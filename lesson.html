<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lesson â€“ Cryptocrib Academy</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,100..1000;1,9..40,100..1000;family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <script src="curriculum.js"></script>
    <script src="dashboard-enhancements.js"></script>
    <script src="lesson-content.js"></script>
</head>
<body class="lesson-body">
    <!-- Lesson Container -->
    <div class="lesson-container" id="lesson-container">
        <!-- Split Layout: Image Left, Content Right -->
        <div class="lesson-split-layout">
            <!-- Left Side: Background Image -->
            <div class="lesson-image-section" id="lesson-image-section">
                <!-- Background image applied via CSS -->
            </div>

            <!-- Right Side: Content Area -->
            <div class="lesson-content-section">
                <!-- Lesson Header -->
                <header class="lesson-header">
                    <h1 class="lesson-main-title" id="lesson-chapter-number">Chapter 1</h1>
                    <h2 class="lesson-subtitle" id="lesson-subtitle">Secrets in Plain Sight</h2>
                </header>

                <!-- Lesson Navigation Tabs -->
                <div class="lesson-tabs">
                    <button class="lesson-tab active" data-tab="info" id="tab-info">Summary</button>
                    <button class="lesson-tab" data-tab="challenges" id="tab-challenges">Quiz</button>
                </div>

                <!-- Lesson Content -->
                <div class="lesson-content-wrapper">
                    <!-- Info Tab Content -->
                    <div class="lesson-tab-content active" id="content-info">
                        <div class="lesson-story-content" id="lesson-story">
                            <!-- Story content loaded dynamically -->
                        </div>
                        <div class="lesson-actions">
                            <button class="btn-start-lesson" id="btn-start-lesson">Start chapter</button>
                        </div>
                    </div>

                    <!-- Challenges Tab Content -->
                    <div class="lesson-tab-content" id="content-challenges">
                        <div class="challenges-list" id="challenges-list">
                            <!-- Challenges loaded dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Code Editor Section (shown for code/challenge lessons) -->
        <div class="code-editor-section hidden" id="code-editor-section">
            <div class="code-editor-tabs">
                <button class="code-tab active" data-lang="javascript">JavaScript</button>
                <button class="code-tab" data-lang="python">Python</button>
            </div>
            <div class="code-editor-container">
                <div class="code-editor" id="code-editor-js">
                    <div class="code-line-numbers" id="line-numbers-js"></div>
                    <textarea class="code-textarea" id="code-textarea-js" spellcheck="false" placeholder="// Enter your code here..."></textarea>
                </div>
                <div class="code-editor hidden" id="code-editor-python">
                    <div class="code-line-numbers" id="line-numbers-python"></div>
                    <textarea class="code-textarea" id="code-textarea-python" spellcheck="false" placeholder="# Enter your code here..."></textarea>
                </div>
            </div>
            <div class="code-actions">
                <button class="btn-run-code" id="btn-run-code">Run Code</button>
                <button class="btn-submit-code" id="btn-submit-code">Submit</button>
            </div>
            <div class="code-output" id="code-output">
                <div class="code-output-header">Output</div>
                <div class="code-output-content" id="code-output-content"></div>
            </div>
        </div>

        <!-- Terminal Simulator (shown for terminal challenges) -->
        <div class="terminal-section hidden" id="terminal-section">
            <div class="terminal-header">
                <div class="terminal-title">Terminal</div>
                <div class="terminal-controls">
                    <span class="terminal-dot red"></span>
                    <span class="terminal-dot yellow"></span>
                    <span class="terminal-dot green"></span>
                </div>
            </div>
            <div class="terminal-content" id="terminal-content">
                <div class="terminal-line">
                    <span class="terminal-prompt">$</span>
                    <span class="terminal-text">Enter your commands here and press Enter...</span>
                </div>
            </div>
            <div class="terminal-input-container">
                <span class="terminal-prompt">$</span>
                <input type="text" class="terminal-input" id="terminal-input" autocomplete="off" />
            </div>
        </div>

        <!-- Quiz Section (shown for quiz lessons) -->
        <div class="quiz-section hidden" id="quiz-section">
            <div class="quiz-question" id="quiz-question">
                <!-- Quiz question loaded dynamically -->
            </div>
            <div class="quiz-options" id="quiz-options">
                <!-- Quiz options loaded dynamically -->
            </div>
            <div class="quiz-feedback hidden" id="quiz-feedback">
                <!-- Feedback shown after answer -->
            </div>
            <div class="quiz-actions">
                <button class="btn-submit-quiz hidden" id="btn-submit-quiz">Submit Answer</button>
                <button class="btn-next-question hidden" id="btn-next-question">Next Question</button>
            </div>
        </div>

        <!-- Success Modal -->
        <div class="success-modal hidden" id="success-modal">
            <div class="success-modal-content">
                <div class="success-icon">âœ“</div>
                <h2>Nicely done!</h2>
                <div class="success-xp">
                    <span class="success-xp-amount" id="success-xp-amount">+50</span>
                    <span class="success-xp-label">XP Earned</span>
                </div>
                <div class="success-actions">
                    <button class="btn-share-x" id="btn-share-x">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/>
                        </svg>
                        Share via X
                    </button>
                    <button class="btn-continue-lesson" id="btn-continue-lesson">Continue</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication
        (function() {
            const authData = localStorage.getItem('cryptocrib_auth');
            if (!authData) {
                window.location.href = 'auth.html';
                return;
            }
            try {
                const auth = JSON.parse(authData);
                if (!auth.isLoggedIn) {
                    window.location.href = 'auth.html';
                    return;
                }
            } catch (e) {
                window.location.href = 'auth.html';
                return;
            }
        })();

        // Make curriculum data available globally
        if (typeof CURRICULUM !== 'undefined') {
            window.CURRICULUM = CURRICULUM;
        }

            // Initialize lesson page
        document.addEventListener('DOMContentLoaded', function() {
            // Parse URL - support both new clean format and old query format
            let pathId, chapterId, lessonId;
            
            // Check for hash-based clean URL: #/beginner/ch1-blockchain-basics/1-1
            const hash = window.location.hash;
            if (hash && hash.startsWith('#/')) {
                const parts = hash.substring(2).split('/');
                if (parts.length >= 3) {
                    pathId = parts[0];
                    chapterId = parts[1];
                    lessonId = parts[2];
                }
            }
            
            // Fallback to query parameters for backward compatibility
            if (!pathId || !chapterId || !lessonId) {
                const urlParams = new URLSearchParams(window.location.search);
                pathId = urlParams.get('path') || 'beginner';
                chapterId = urlParams.get('chapter') || '';
                lessonId = urlParams.get('lesson') || '';
                
                // Update URL to clean format if using old format
                if (pathId && chapterId && lessonId && window.location.hash !== `#/${pathId}/${chapterId}/${lessonId}`) {
                    window.history.replaceState(null, '', `lesson.html#/${pathId}/${chapterId}/${lessonId}`);
                }
            }
            
            // Make available globally for quiz completion
            window.urlParams = { path: pathId, chapter: chapterId, lesson: lessonId };

            if (!window.CURRICULUM || !window.CURRICULUM[pathId]) {
                console.error('Path not found');
                return;
            }

            const path = window.CURRICULUM[pathId];
            const chapter = path.chapters.find(ch => ch.id === chapterId);
            if (!chapter) {
                console.error('Chapter not found');
                return;
            }

            const lesson = chapter.lessons.find(l => l.id === lessonId);
            if (!lesson) {
                console.error('Lesson not found');
                return;
            }

            // Initialize dashboard enhancements
            if (!window.dashboardEnhancements) {
                window.dashboardEnhancements = new DashboardEnhancements();
            }

            // Set background image based on chapter
            const chapterImages = {
                'ch1-blockchain-basics': 'chapter-1',
                'ch2-bitcoin': 'chapter-2',
                'ch3-wallets': 'chapter-3',
                'ch4-ethereum-basics': 'chapter-4',
                'ch5-layer2': 'chapter-5'
            };
            const imageClass = chapterImages[chapterId] || 'chapter-1';
            const imageSection = document.getElementById('lesson-image-section');
            if (imageSection) {
                imageSection.className = 'lesson-image-section ' + imageClass;
            }

            // Get chapter number from chapter title (e.g., "Chapter 1" -> "1")
            const chapterMatch = chapter.title.match(/\d+/);
            const chapterNumber = chapterMatch ? chapterMatch[0] : '1';

            // Update lesson info
            document.getElementById('lesson-chapter-number').textContent = `Chapter ${chapterNumber}`;
            
            // Set subtitle to lesson title
            const subtitleElement = document.getElementById('lesson-subtitle');
            subtitleElement.textContent = lesson.title;

            // Load story content
            loadStoryContent(lesson, chapter, path);

            // Load challenges
            loadChallenges(lesson, chapter);

            // Setup tab switching
            document.querySelectorAll('.lesson-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    document.querySelectorAll('.lesson-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.lesson-tab-content').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    document.getElementById(`content-${tabName}`).classList.add('active');
                });
            });

            // Setup code editor tabs
            document.querySelectorAll('.code-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const lang = this.dataset.lang;
                    document.querySelectorAll('.code-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.code-editor').forEach(e => e.classList.add('hidden'));
                    this.classList.add('active');
                    document.getElementById(`code-editor-${lang}`).classList.remove('hidden');
                });
            });

            // Setup start lesson button - update text with chapter number
            const startButton = document.getElementById('btn-start-lesson');
            const chapterMatchFinal = chapter.title.match(/\d+/);
            const chapterNumberFinal = chapterMatchFinal ? chapterMatchFinal[0] : '1';
            startButton.textContent = `Start chapter ${chapterNumberFinal}`;
            startButton.addEventListener('click', function() {
                startLesson(lesson);
            });

            // Setup code editor
            setupCodeEditor(lesson);

            // Setup terminal
            setupTerminal(lesson);

            // Setup quiz - will be initialized when lesson starts
            // Don't call setupQuiz here, it will be called when user starts the lesson

            function loadStoryContent(lesson, chapter, path) {
                const storyContent = document.getElementById('lesson-story');
                let storyText = '';
                
                // Check if we have content for this lesson
                if (window.LESSON_CONTENT && window.LESSON_CONTENT[lesson.id]) {
                    const content = window.LESSON_CONTENT[lesson.id];
                    storyText = content.story || '';
                    
                    // Add resource summary if available
                    if (content.resourceSummary) {
                        storyText += content.resourceSummary;
                    }
                } else {
                    // Fallback to generated content
                    storyText = generateStoryContent(lesson, chapter, path);
                }
                
                storyContent.innerHTML = storyText;
            }

            function generateStoryContent(lesson, chapter, path) {
                // Fallback content generator
                return `
                    <div class="story-paragraph">
                        <p>Welcome to ${lesson.title}!</p>
                        <p>In this lesson, you'll learn about ${chapter.title.toLowerCase()} and how it relates to ${path.title.toLowerCase()}.</p>
                        <p>${lesson.type === 'code' ? 'You\'ll get hands-on experience writing code.' : ''}
                        ${lesson.type === 'challenge' ? 'This is a challenging exercise that will test your understanding.' : ''}
                        ${lesson.type === 'interactive' ? 'This is an interactive lesson with hands-on activities.' : ''}
                        ${lesson.type === 'reading' ? 'Read through the content carefully and take notes.' : ''}</p>
                    </div>
                `;
            }

            function loadChallenges(lesson, chapter) {
                const challengesList = document.getElementById('challenges-list');
                // Generate challenges list
                challengesList.innerHTML = `
                    <div class="challenge-item">
                        <div class="challenge-icon">${lesson.type === 'code' ? 'ðŸ’»' : lesson.type === 'challenge' ? 'âš¡' : 'ðŸ“–'}</div>
                        <div class="challenge-content">
                            <h3>${lesson.title}</h3>
                            <p>${lesson.type.charAt(0).toUpperCase() + lesson.type.slice(1)} â€¢ ${lesson.duration} min â€¢ +${lesson.xp} XP</p>
                        </div>
                        <div class="challenge-status">
                            <button class="btn-start-challenge" onclick="viewLessonDetails()">Start</button>
                        </div>
                    </div>
                `;
            }
            
            function viewLessonDetails() {
                // Switch to Info tab to show complete details
                document.getElementById('tab-info').click();
                // Scroll to top of lesson content
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            // Make viewLessonDetails available globally
            window.viewLessonDetails = viewLessonDetails;

            function startLesson(lesson) {
                // Always show quiz for all lesson types (users can take quiz after reading/learning)
                // Code/challenge lessons will have quiz AND code editor
                document.getElementById('quiz-section').classList.remove('hidden');
                setupQuiz(lesson);
                
                // Also show code editor if it's a code/challenge lesson
                if (lesson.type === 'code' || lesson.type === 'challenge') {
                    document.getElementById('code-editor-section').classList.remove('hidden');
                }
            }

            function setupCodeEditor(lesson) {
                const textareaJs = document.getElementById('code-textarea-js');
                const textareaPython = document.getElementById('code-textarea-python');

                // Update line numbers
                function updateLineNumbers(textarea, lineNumbersEl) {
                    const lines = textarea.value.split('\n').length;
                    lineNumbersEl.innerHTML = Array.from({ length: lines }, (_, i) => `<div>${i + 1}</div>`).join('');
                }

                textareaJs.addEventListener('input', () => updateLineNumbers(textareaJs, document.getElementById('line-numbers-js')));
                textareaPython.addEventListener('input', () => updateLineNumbers(textareaPython, document.getElementById('line-numbers-python')));

                // Run code button
                document.getElementById('btn-run-code').addEventListener('click', function() {
                    const activeLang = document.querySelector('.code-tab.active').dataset.lang;
                    const code = document.getElementById(`code-textarea-${activeLang}`).value;
                    runCode(code, activeLang);
                });

                // Submit code button
                document.getElementById('btn-submit-code').addEventListener('click', function() {
                    const activeLang = document.querySelector('.code-tab.active').dataset.lang;
                    const code = document.getElementById(`code-textarea-${activeLang}`).value;
                    submitCode(code, activeLang, lesson);
                });
            }

            function runCode(code, lang) {
                const output = document.getElementById('code-output-content');
                output.innerHTML = '<div class="output-line">Running code...</div>';
                
                // Simple code execution (in production, this would be done server-side)
                setTimeout(() => {
                    output.innerHTML = '<div class="output-line">Code executed successfully!</div>';
                }, 500);
            }

            function submitCode(code, lang, lesson) {
                // Validate code and show success
                showSuccessModal(lesson.xp, lesson);
            }

            function setupTerminal(lesson) {
                const terminalInput = document.getElementById('terminal-input');
                const terminalContent = document.getElementById('terminal-content');

                terminalInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const command = this.value;
                        executeTerminalCommand(command);
                        this.value = '';
                    }
                });
            }

            function executeTerminalCommand(command) {
                const terminalContent = document.getElementById('terminal-content');
                const terminalInput = document.getElementById('terminal-input');
                
                // Add command to terminal
                terminalContent.innerHTML += `
                    <div class="terminal-line">
                        <span class="terminal-prompt">$</span>
                        <span class="terminal-text">${command}</span>
                    </div>
                `;

                // Simple command execution
                let output = '';
                if (command.startsWith('echo')) {
                    output = command.substring(5).trim();
                } else {
                    output = 'Command executed';
                }

                terminalContent.innerHTML += `
                    <div class="terminal-line output">
                        <span class="terminal-text">${output}</span>
                    </div>
                `;

                terminalContent.scrollTop = terminalContent.scrollHeight;
            }

            let currentQuiz = null;
            let currentQuestionIndex = 0;
            let quizScore = 0;

            function setupQuiz(lesson) {
                // Check if lesson has quiz content
                if (window.LESSON_CONTENT && window.LESSON_CONTENT[lesson.id] && window.LESSON_CONTENT[lesson.id].quiz) {
                    currentQuiz = window.LESSON_CONTENT[lesson.id].quiz;
                } else {
                    // Default quiz if no content available
                    currentQuiz = [
                        {
                            question: 'What is blockchain?',
                            options: ['A distributed ledger', 'A cryptocurrency', 'A programming language', 'A database'],
                            correct: 0,
                            explanation: 'Blockchain is a distributed ledger technology that maintains records across multiple nodes.'
                        }
                    ];
                }
                
                currentQuestionIndex = 0;
                quizScore = 0;
                
                // Load first question
                loadQuizQuestion();
            }

            function loadQuizQuestion() {
                if (!currentQuiz || currentQuestionIndex >= currentQuiz.length) {
                    // Quiz completed
                    completeQuiz();
                    return;
                }

                const question = currentQuiz[currentQuestionIndex];
                const quizQuestion = document.getElementById('quiz-question');
                const quizOptions = document.getElementById('quiz-options');
                const quizFeedback = document.getElementById('quiz-feedback');
                const submitBtn = document.getElementById('btn-submit-quiz');
                const nextBtn = document.getElementById('btn-next-question');

                // Reset UI
                quizQuestion.textContent = question.question;
                quizOptions.innerHTML = '';
                quizFeedback.classList.add('hidden');
                submitBtn.classList.remove('hidden');
                nextBtn.classList.add('hidden');

                // Create options
                question.options.forEach((option, index) => {
                    const optionEl = document.createElement('div');
                    optionEl.className = 'quiz-option';
                    optionEl.textContent = option;
                    optionEl.dataset.index = index;
                    optionEl.addEventListener('click', function() {
                        // Remove selection from all options
                        document.querySelectorAll('.quiz-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        // Select this option
                        this.classList.add('selected');
                    });
                    quizOptions.appendChild(optionEl);
                });

                // Setup submit button
                submitBtn.onclick = function() {
                    checkQuizAnswer(question);
                };
            }

            function checkQuizAnswer(question) {
                const selectedOption = document.querySelector('.quiz-option.selected');
                if (!selectedOption) {
                    alert('Please select an answer');
                    return;
                }

                const selectedIndex = parseInt(selectedOption.dataset.index);
                const isCorrect = selectedIndex === question.correct;
                
                // Show feedback
                const quizFeedback = document.getElementById('quiz-feedback');
                const submitBtn = document.getElementById('btn-submit-quiz');
                const nextBtn = document.getElementById('btn-next-question');

                // Mark correct/incorrect
                document.querySelectorAll('.quiz-option').forEach((opt, index) => {
                    if (index === question.correct) {
                        opt.classList.add('correct');
                    } else if (index === selectedIndex && !isCorrect) {
                        opt.classList.add('incorrect');
                    }
                });

                // Show feedback
                quizFeedback.innerHTML = isCorrect 
                    ? `<div class="feedback-correct">âœ“ Correct! ${question.explanation || ''}</div>`
                    : `<div class="feedback-incorrect">âœ— Incorrect. The correct answer is: ${question.options[question.correct]}. ${question.explanation || ''}</div>`;
                quizFeedback.classList.remove('hidden');

                if (isCorrect) {
                    quizScore++;
                    // Hide submit, show next button
                    submitBtn.classList.add('hidden');
                    nextBtn.classList.remove('hidden');
                    
                    // Setup next button
                    nextBtn.onclick = function() {
                        currentQuestionIndex++;
                        loadQuizQuestion();
                    };
                } else {
                    // Allow user to try again or move on
                    submitBtn.textContent = 'Try Again';
                    submitBtn.onclick = function() {
                        // Reset and reload question
                        currentQuestionIndex = currentQuestionIndex; // Keep same question
                        loadQuizQuestion();
                    };
                }
            }

            function completeQuiz() {
                const quizSection = document.getElementById('quiz-section');
                const totalQuestions = currentQuiz.length;
                const percentage = Math.round((quizScore / totalQuestions) * 100);
                
                // Get lesson info for completion - use global urlParams
                const pathId = window.urlParams?.path || 'beginner';
                const chapterId = window.urlParams?.chapter || '';
                const lessonId = window.urlParams?.lesson || '';
                
                quizSection.innerHTML = `
                    <div class="quiz-complete">
                        <div class="quiz-complete-icon">ðŸŽ‰</div>
                        <h2>Quiz Complete!</h2>
                        <div class="quiz-score">
                            <div class="score-value">${quizScore}/${totalQuestions}</div>
                            <div class="score-percentage">${percentage}%</div>
                        </div>
                        <p>Great job! You scored ${percentage}% on this quiz.</p>
                        <button class="btn-continue-lesson" onclick="window.location.href='courses.html#/${pathId}'">Continue Learning</button>
                    </div>
                `;
                
                // Complete lesson with quiz score
                const lesson = window.CURRICULUM[pathId].chapters.find(ch => ch.id === chapterId).lessons.find(l => l.id === lessonId);
                window.dashboardEnhancements.completeLesson(lessonId, chapterId, pathId, lesson.xp, percentage);
            }

            function showSuccessModal(xp, lesson) {
                const modal = document.getElementById('success-modal');
                document.getElementById('success-xp-amount').textContent = `+${xp}`;
                modal.classList.remove('hidden');

                // Complete lesson - use global urlParams
                const pathId = window.urlParams?.path || 'beginner';
                const chapterId = window.urlParams?.chapter || '';
                const lessonId = window.urlParams?.lesson || '';

                window.dashboardEnhancements.completeLesson(lessonId, chapterId, pathId, xp, 100);

                // Setup continue button
                document.getElementById('btn-continue-lesson').addEventListener('click', function() {
                    // Navigate to next lesson or back to courses
                    window.location.href = 'courses.html#/' + pathId;
                });

                // Setup share button
                document.getElementById('btn-share-x').addEventListener('click', function() {
                    const text = `I just completed "${lesson.title}" on Cryptocrib and earned ${xp} XP! ðŸš€`;
                    const url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
                    window.open(url, '_blank');
                });
            }

            // Make startLesson available globally
            window.startLesson = function() {
                startLesson(lesson);
            };
        });
    </script>
</body>
</html>

